#!/usr/bin/env bash

set -e

cd "$(dirname "$0")/.."

# Ensure config directory exists
if [[ ! -d "${PWD}/config" ]]; then
    echo "Creating Home Assistant config directory..."
    mkdir -p "${PWD}/config"
fi

# Create secrets.yaml if it doesn't exist
if [[ ! -f "${PWD}/config/secrets.yaml" ]]; then
    echo "Creating secrets.yaml template..."
    cat > "${PWD}/config/secrets.yaml" <<EOF
# Secrets for development
# Add your Meraki API key here:
# meraki_api_key: "your_api_key_here"
EOF
fi

# Set the path to custom_components
# This allows us to have the structure <root>/custom_components/meraki_dashboard
# while at the same time have Home Assistant configuration inside <root>/config
export PYTHONPATH="${PYTHONPATH}:${PWD}"

echo ""
echo "Starting Home Assistant in development mode..."
echo "Custom components path: ${PWD}/custom_components"
echo "Config directory: ${PWD}/config"
echo ""
echo "After starting, Home Assistant will be available at:"
echo "  http://localhost:8123"
echo ""
echo "Press Ctrl+C to stop"
echo ""

# Start Home Assistant using uv run
# This ensures we use the uv-managed environment with correct dependencies
if command -v uv &> /dev/null; then
    uv run hass --config "${PWD}/config" --debug
else
    echo "Error: 'uv' command not found!"
    echo ""
    echo "Please run 'make install' to set up the development environment"
    echo "This will install uv and all required dependencies"
    echo ""
    exit 1
fi
